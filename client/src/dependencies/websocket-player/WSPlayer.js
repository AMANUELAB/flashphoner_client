//LICENSE! This Code can be used and executed as a part of Flashphoner Web Call Server platform and having an appropriate Web Call Server license. You shall not use this code separately from Web Call Server platform. Contacts: http://flashphoner.com, support@flashphoner.com.
var requestAnimFrame=(function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||function(callback){window.setTimeout(callback,16.666666666666668);};})();function WSPlayer(canvas){this.canvas=canvas;this.w=false;this.J=[];}WSPlayer.prototype.init=function(F){this.F=F;this.g=true;try{window.AudioContext=window.AudioContext||window.webkitAudioContext;var audioContext=new AudioContext;audioContext.close();audioContext=new AudioContext;if(this.V){this.V.M.close();}this.V=new AudioPlayer(audioContext,this.m.bind(this));}catch(e){wsLogger.error("Failed to init audio player "+e);return;}try{this.R=new VideoRenderer(this.canvas,F.videoWidth,F.videoHeight,true);this.R.init();}catch(e){wsLogger.error("Failed to init video renderer "+e);return;}try{if(this.W){this.W.terminate();}this.W=new Worker(F.receiverPath);this.W.addEventListener("message",(function(e){switch(e.data.message){case"avail":this.g=false;this.m();this.unmute();break;case"failed":this.stop();this.w=false;this.Aw("Websocket connection failed!");break;case"AVData":if(e.data.flushIndicator){this.V.BD();this.J=[];}this.g=false;var i;if(e.data.audio.length>0&&!this.F.startWithVideoOnly){for(i=0;i<e.data.audio.length;i++){this.V.BB(e.data.audio[i]);}}if(e.data.video.length>0){for(i=0;i<e.data.video.length;i++){this.J.push(e.data.video[i]);}requestAnimFrame(this.AB.bind(this));}else if(this.F.startWithVideoOnly){this.m();}if(e.data.noAudioDataAvailableIndicator&&this.V.Ax()>0&&!this.F.startWithVideoOnly){if(this.V.Ar){if(this.V.Au()==0){this.o=Date.now();this.AF=true;}}}else if(e.data.noVideoDataAvailableIndicator&&this.R.Av()){var BF=500;if(Date.now()-this.R.Av()>BF){this.o=Date.now();this.AF=true;}}else if(this.o>0){if(Date.now()-this.o>2000){this.AF=false;this.o=0;}}break;default:wsLogger.error("Unknown request");}}).bind(this),false);var conf={};conf.audioChunkLength=this.V.internalBufferSize;conf.audioContextSampleRate=this.V.M.sampleRate;conf.videoWidth=F.videoWidth;conf.videoHeight=F.videoHeight;conf.urlWsServer=F.urlWsServer;conf.token=F.token;conf.audioBufferWaitFor=F.audioBufferWaitFor;conf.videoBufferWaitFor=F.videoBufferWaitFor;conf.dropDelayMultiplier=F.dropDelayMultiplier;conf.videoFaststart=F.startWithVideoOnly;this.W.postMessage({message:"init",data:conf});}catch(e){wsLogger.error("Failed to init stream receiver "+e);return;}this.AH=0;this.p=0;this._=0;this.AF=false;this.o=0;this.w=true;};WSPlayer.prototype.play=function(){if(!this.w){this.init(this.F);}this.g=true;this.W.postMessage({message:"play"});if(!this.F.startWithVideoOnly){this.V.start();}};WSPlayer.prototype.pause=function(){this.g=true;this.mute();this.W.postMessage({message:"pause"});};WSPlayer.prototype.mute=function(){if(this.V){this.V.mute(true);}if(this.R){this.R.mute(true);}};WSPlayer.prototype.unmute=function(){if(this.V){this.V.mute(false);}if(this.R){this.R.mute(false);}};WSPlayer.prototype.resume=function(){this.W.postMessage({message:"resume"});};WSPlayer.prototype.playFirstSound=function(){if(this.w==false){this.init(this.F);}var b=this.V.M.createBuffer(1,441,44100);var j=b.getChannelData(0);for(var i=0;i<j.length;i++){j[i]=Math.random()*2-1;}var src=this.V.M.createBufferSource();src.buffer=b;src.connect(this.V.l);src.start(0);if(this.F.startWithVideoOnly){this.F.startWithVideoOnly=false;this.V.start();}};WSPlayer.prototype.stop=function(){this.g=true;if(this.W){this.W.postMessage({message:"stop"});}if(this.V){this.V.stop();}if(this.R){this.R.stop();}this.J=[];this.AH=0;this.p=0;this._=0;};WSPlayer.prototype.m=function(){if(!this.g){this.g=true;this.W.postMessage({message:"feed",data:{audioBuffSize:this.V.Au(),videoBuffSize:this.J.length}});}if(this.J.length>=5){this.AB();}};WSPlayer.prototype.AB=function(A6){if(!this.w){return;}if(this.J.length>0){var h=this.V.Ax();if(h==-1){h=this.J[0].sync;}wsLogger.trace("requestVideoFrameCallback, audio player time "+h+" callback timestamp "+A6);var u=0;while(this.J.length!=0){u=this.J[0].sync;if(h-u>100){wsLogger.debug("Drop old decoded video frame from buffer, ts "+u+" video time "+u+" audio time "+h+" video_late_ms "+(h-u)+" time now "+Date.now());this.J.shift();wsLogger.debug("Frames in buffer "+this.J.length);}else{break;}}if(this.J.length!=0&&this.J[0].sync<=h){var AZ=this.R.createImageData();AZ.data.set(this.J.shift().payload);this.R.AW(AZ);this._++;}if(this.J.length==0){this.m();}else if(this.J.length<3){this.m();requestAnimFrame(this.AB.bind(this));}else{requestAnimFrame(this.AB.bind(this));}}else{this.m();}if(this.F.CO){if(this.p==0){this.p=Date.now();}else if(Date.now()-this.p>990){this.AH=this._;this._=0;this.p=Date.now();}this.BN("FPS:"+this.AH);}if(this.AF){this.Aw("Bad internet connection!");}};WSPlayer.prototype.Aw=function(text){var O=this.R.c;if(O){var textSize=O.measureText(text);O.fillStyle="white";var Ak=30;O.fillRect(0,this.canvas.height/2-Ak/2,this.canvas.width,Ak);O.fillStyle="black";O.font="30pt";O.textAlign="center";O.fillText(text,this.canvas.width/2,this.canvas.height/2);}else{}};WSPlayer.prototype.BN=function(text){var O=this.R.c;if(O){O.fillStyle="red";O.font="40pt";O.fillText(text,20,this.canvas.height-20);}else{}};WSPlayer.prototype.initLogger=function(verbosity){this.verbosity=verbosity||0;var I=this;if(window.wsLogger==undefined){window.wsLogger={log:function(){if(I.verbosity>=2){window.console.log.apply(window.console,arguments);}},warn:function(){if(I.verbosity>=1){window.console.warn.apply(window.console,arguments);}},error:function(){if(I.verbosity>=0){window.console.error.apply(window.console,arguments);}},debug:function(){if(I.verbosity>=3){window.console.log.apply(window.console,arguments);}},trace:function(){if(I.verbosity>=4){window.console.log.apply(window.console,arguments);}}};}if(window.wsLogger.debug==undefined){window.wsLogger.debug=function(){if(I.verbosity>=3){window.console.log.apply(window.console,arguments);}};}if(window.wsLogger.trace==undefined){window.wsLogger.trace=function(){if(I.verbosity>=4){window.console.log.apply(window.console,arguments);}};}};var VideoRenderer=function(canvas,width,height,AQ){this.canvas=canvas;this.width=width;this.height=height;this.AC=null;this.c=null;this.AQ=AQ;this.B=null;this.Z=null;this.buffer=null;this.Ab=null;this.Ad=null;this.Ae=null;this.AT=false;var Af=parseInt(width)+15>>4;this.BM=Af<<4;this.Al=Af<<3;this.A4=["precision mediump float;","uniform sampler2D YTexture;","uniform sampler2D CBTexture;","uniform sampler2D CRTexture;","varying vec2 texCoord;","void main() {","float y = texture2D(YTexture, texCoord).r;","float cr = texture2D(CBTexture, texCoord).r - 0.5;","float cb = texture2D(CRTexture, texCoord).r - 0.5;","gl_FragColor = vec4(","y + 1.4 * cr,","y + -0.343 * cb - 0.711 * cr,","y + 1.765 * cb,","1.0",");","}"].join("\n");this.A3=["attribute vec2 vertex;","varying vec2 texCoord;","void main() {","texCoord = vertex;","gl_Position = vec4((vertex * 2.0 - 1.0) * vec2(1, -1), 0.0, 1.0);","}"].join("\n");};VideoRenderer.prototype.init=function(){if(!this.AQ){try{var B=this.B=this.canvas.getContext("webgl")||this.canvas.getContext("experimental-webgl");}catch(e){wsLogger.error("Failed to get webgl context, error "+e);}}if(B){this.buffer=B.createBuffer();B.bindBuffer(B.A8,this.buffer);B.CV(B.A8,new Float32Array([0,0,0,1,1,0,1,1]),B.CW);this.Z=B.createProgram();B.A_(this.Z,this.AN(B.CY,this.A3));B.A_(this.Z,this.AN(B.CQ,this.A4));B.CU(this.Z);if(!B.CP(this.Z,B.CH)){wsLogger.error("Failed to init WebGL! Message "+B.CE(this.Z));this.c=this.canvas.getContext("2d");this.AC=this.Aa;return;}B.CF(this.Z);this.Ab=this.AD(0,"YTexture");this.Ad=this.AD(1,"CBTexture");this.Ae=this.AD(2,"CRTexture");var AX=B.CG(this.Z,"vertex");B.CI(AX);B.CN(AX,2,B.FLOAT,false,0,0);B.CJ(0,0,this.width,this.height);this.AC=this.BC;}else{this.c=this.canvas.getContext("2d");this.AC=this.Aa;}};VideoRenderer.prototype.stop=function(){this.AW(this.createImageData());};VideoRenderer.prototype.AD=function(index,name){var B=this.B;var AY=B.AD();B.AP(B.U,AY);B.AV(B.U,B.CK,B.A5);B.AV(B.U,B.CL,B.A5);B.AV(B.U,B.Bq,B.BJ);B.AV(B.U,B.CA,B.BJ);B.Bo(B.BY(this.Z,name),index);return AY;};VideoRenderer.prototype.AN=function(type,source){var B=this.B;var q=B.BX(type);B.BU(q,source);B.AN(q);if(!B.Ba(q,B.Bb)){throw new Error(B.Bi(q));}return q;};VideoRenderer.prototype.Bm=function(){return(this.B!==null||this.B!==undefined)&&(this.c==null||this.c==undefined);};VideoRenderer.prototype.BC=function(data){var B=this.B;var A$=new Uint8Array(data.y.buffer),A7=new Uint8Array(data.Bj.buffer),A9=new Uint8Array(data.Bg.buffer);B.Ac(B.Be);B.AP(B.U,this.Ab);B.Ai(B.U,0,B.v,this.BM,this.height,0,B.v,B.Ah,A$);B.Ac(B.Bh);B.AP(B.U,this.Ad);B.Ai(B.U,0,B.v,this.Al,this.height/2,0,B.v,B.Ah,A7);B.Ac(B.Bl);B.AP(B.U,this.Ae);B.Ai(B.U,0,B.v,this.Al,this.height/2,0,B.v,B.Ah,A9);B.Bc(B.BZ,0,4);};VideoRenderer.prototype.Aa=function(data){this.c.putImageData(data,0,0);};VideoRenderer.prototype.AW=function(data){if(!this.AT){this.AC(data);}this.BE=Date.now();};VideoRenderer.prototype.Av=function(){return this.BE;};VideoRenderer.prototype.createImageData=function(){return this.c.createImageData(this.width,this.height);};VideoRenderer.prototype.mute=function(mute){if(mute){this.AT=true;}else{this.AT=false;}};function AudioPlayer(audioContext,requestDataCallback){var I=this;this.Am();this.AK=false;this.M=audioContext;this.l=audioContext.createGain();this.l.connect(audioContext.destination);this.mute(true);wsLogger.log("Sample rate "+this.M.sampleRate);this.requestDataCallback=requestDataCallback;var t=[];var i;for(i=256;i<=16384;i=i*2){t.push(i);}var Ao=this.M.sampleRate/10;var z=t[0];var As=Math.abs(Ao-z);for(i=0;i<t.length;i++){var At=Math.abs(Ao-t[i]);if(At<As){As=At;z=t[i];}}wsLogger.log("Audio node buffer size "+z);this.internalBufferSize=z;try{this.M.createScriptProcessor=this.M.createScriptProcessor||this.M.createJavaScriptNode;this.AO=this.M.createScriptProcessor(this.internalBufferSize,1,1);}catch(e){wsLogger.error("JS Audio Node is not supported in this browser"+e);}this.AO.onaudioprocess=function(event){var A1;var j=event.outputBuffer.getChannelData(0);var i;if(I.b.length>0){var A0=I.b.shift();A1=A0.payload;for(i=0;i<j.length;i++){j[i]=A1[i];}I.AE=A0.sync;I.d=Date.now();I.Ar=false;}else{for(i=0;i<j.length;i++){j[i]=0;}I.Ar=true;if(I.l.gain.value!=0&&I.d){wsLogger.debug("No audio in audio buffer!");}}I.requestDataCallback();};}AudioPlayer.prototype.start=function(){if(!this.AK){this.AO.connect(this.l);this.AK=true;}this.mute(false);};AudioPlayer.prototype.stop=function(){this.AO.disconnect();this.AK=false;this.AE=undefined;this.d=undefined;this.b=[];this.mute(true);};AudioPlayer.prototype.Am=function(){this.b=[];};AudioPlayer.prototype.BD=function(){this.Am();};AudioPlayer.prototype.BB=function(BL){this.b.push(BL);};AudioPlayer.prototype.Au=function(){return this.b.length;};AudioPlayer.prototype.Ax=function(){if(this.AE&&this.d){if(Date.now()-this.d>this.internalBufferSize/this.M.sampleRate*1000*1.5){wsLogger.debug("No audio! "+(Date.now()-this.d)+" size "+this.internalBufferSize/this.M.sampleRate*1000);return this.internalBufferSize/this.M.sampleRate*1000+this.AE;}return Date.now()-this.d+this.AE;}return-1;};AudioPlayer.prototype.Ca=function(){return this.d;};AudioPlayer.prototype.mute=function(mute){if(mute){wsLogger.log("Audio player mute");this.l.gain.value=0;}else{wsLogger.log("Audio player resume");this.l.gain.value=1;}};